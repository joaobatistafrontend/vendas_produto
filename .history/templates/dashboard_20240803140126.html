<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Dashboard de Vendas</h1>

        <div class="row">
            <div class="col-md-4">
                <div class="card text-white bg-primary">
                    <div class="card-header">Total de Vendas</div>
                    <div class="card-body">
                        <h5 class="card-title">R${{ total }}</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-info">
                    <div class="card-header">Total de Vendas do Dia</div>
                    <div class="card-body">
                        <h5 class="card-title">R${{ total_dia }}</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-warning">
                    <div class="card-header">Total de Vendas da Semana</div>
                    <div class="card-body">
                        <h5 class="card-title">R${{ total_semana }}</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-danger">
                    <div class="card-header">Total de Vendas do Mês</div>
                    <div class="card-body">
                        <h5 class="card-title">R${{ total_mes }}</h5>
                    </div>
                </div>
            </div>

            {% if mais_vendido %}
            <div class="col-md-8">
                <div class="card text-white bg-success">
                    <div class="card-header">Produto Mais Vendido</div>
                    <div class="card-body">
                        <h5 class="card-title">Produto: {{ mais_vendido.produto__nome_produto }}</h5>
                        <p class="card-text">Quantidade Vendida: {{ mais_vendido.total_vendido }}</p>
                        <p class="card-text">Total Arrecadado: R${{ mais_vendido.total_revenue }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="card">
            <div class="card-header">Detalhes das Vendas</div>
            <div class="card-body">
                <ul class="list-group">
                    {% for venda in vendas %}
                        <li class="list-group-item">
                            {{ venda.produto.nome_produto }} - {{ venda.qtd }} unidades - Total: R${{ venda.total }} - Data: {{ venda.data_venda }}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>


        class IndexMes(TemplateView):
        template_name = 'dashboard.html'
        
        def get(self, request):
            vendas = VendaDoProduto.objects.all()
            
            # Calcula a soma total de todas as vendas
            total = sum(item.total for item in vendas if item.total)
            
            # Calcula a quantidade total vendida de cada produto e o total em vendas
            produtos_vendidos = VendaDoProduto.objects.values('produto__nome_produto').annotate(
                total_vendido=Sum('qtd'), total_revenue=Sum('total')
            ).order_by('-total_vendido')
            
            # Obtém o produto mais vendido
            mais_vendido = produtos_vendidos.first() if produtos_vendidos else None
    
            # Obtém a data atual
            hoje = datetime.now().date()
            
            # Filtra as vendas do dia
            vendas_dia = VendaDoProduto.objects.filter(data_venda=hoje)
            total_dia = sum(item.total for item in vendas_dia if item.total)
            
            # Filtra as vendas da semana
            inicio_semana = hoje - timedelta(days=hoje.weekday())
            vendas_semana = VendaDoProduto.objects.filter(data_venda__gte=inicio_semana, data_venda__lte=hoje)
            total_semana = sum(item.total for item in vendas_semana if item.total)
            
            # Filtra as vendas do mês
            inicio_mes = hoje.replace(day=1)
            vendas_mes = VendaDoProduto.objects.filter(data_venda__gte=inicio_mes, data_venda__lte=hoje)
            total_mes = sum(item.total for item in vendas_mes if item.total)
    
            # Agrupa as vendas por mês
            vendas_mensais = VendaDoProduto.objects.values('data_venda__year', 'data_venda__month').annotate(
                total_mensal=Sum('total')
            ).order_by('data_venda__year', 'data_venda__month')
    
            # Determina o primeiro mês com vendas
            if vendas_mensais:
                primeiro_ano = vendas_mensais[0]['data_venda__year']
                primeiro_mes = vendas_mensais[0]['data_venda__month']
            else:
                primeiro_ano = None
                primeiro_mes = None
            
            return render(request, self.template_name, {
                'vendas': vendas,
                'total': total,
                'mais_vendido': mais_vendido,
                'total_dia': total_dia,
                'total_semana': total_semana,
                'total_mes': total_mes,
                'vendas_mensais': vendas_mensais,
                'primeiro_ano': primeiro_ano,
                'primeiro_mes': primeiro_mes,
            })
    

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
